import{s as e}from"./index-CxPD7nDI.js";const t=async t=>{try{const{error:a}=await e.from("leads").insert({landing_id:t.landing_id,page_title:t.page_title,name:t.name,phone:t.phone,privacy_consent:!0,marketing_consent:!!t.marketing_consent,form_data:t,ip:t.ip||null,user_agent:t.user_agent||null,referrer:t.referrer||null});return!a}catch(a){return!1}},a=async()=>{try{const{data:t,error:a}=await e.from("leads").select("*").order("created_at",{ascending:!1});return a?[]:(t||[]).map(e=>({timestamp:e.created_at,landing_id:e.landing_id,name:e.name,phone:e.phone,page_title:e.page_title,user_agent:e.user_agent||"",referrer:e.referrer||"",...e.form_data||{}}))}catch(t){return[]}},n=async()=>{try{const{data:t,error:a}=await e.from("configs").select("config_data").eq("id","system_global_v1").single();return a?(a.code,null):(null==t?void 0:t.config_data)||null}catch(t){return null}},r=async t=>{try{const{error:a}=await e.from("configs").upsert({id:"system_global_v1",config_data:t,updated_at:(new Date).toISOString()},{onConflict:"id"});return!a}catch(a){return!1}},o=async t=>{try{const{data:a,error:n}=await e.from("configs").select("config_data").eq("id",t).single();return n?(n.code,null):(null==a?void 0:a.config_data)||null}catch(a){return null}},s=async t=>{try{const{error:a}=await e.from("configs").upsert({id:t.id,config_data:t,updated_at:(new Date).toISOString()},{onConflict:"id"});return!a}catch(a){return!1}},i=async t=>{try{const{error:a}=await e.from("configs").delete().eq("id",t);return!a}catch(a){return!1}},c=async t=>{try{const{error:a}=await e.from("visits").insert({landing_id:t["Landing ID"]||t.landing_id,ip:t.IP||t.ip,referrer:t.Referrer||t.referrer,user_agent:t.user_agent,meta:t});return!a}catch(a){return!1}},d=async()=>{try{const{data:t,error:a}=await e.from("visits").select("*").order("created_at",{ascending:!1}).limit(1e3);return a?[]:(t||[]).map(e=>({timestamp:e.created_at,landing_id:e.landing_id,ip:e.ip,referrer:e.referrer,...e.meta||{}}))}catch(t){return[]}},l=async t=>{try{const{error:a}=await e.from("leads").insert({landing_id:t.landing_id||"ai_diagnosis",name:t.name,phone:t.phone,page_title:"AI 변제금 진단",form_data:{type:"rehab_diagnosis",address:t.address,monthlyIncome:t.monthlyIncome,familySize:t.familySize,totalDebt:t.totalDebt,assets:t.assets,spouseAssets:t.spouseAssets,monthlyPayment:t.monthlyPayment,debtReductionRate:t.debtReductionRate,courtName:t.courtName,status:t.status},privacy_consent:!0});return!a}catch(a){return!1}},p=Object.freeze(Object.defineProperty({__proto__:null,deleteLandingConfig:i,fetchDraft:async t=>{try{const{data:a,error:n}=await e.from("configs").select("config_data").eq("id",`draft_${t}`).single();return n?(n.code,null):(null==a?void 0:a.config_data)||null}catch(a){return null}},fetchGlobalSettings:n,fetchLandingConfig:o,fetchLeads:a,fetchVisits:d,logVisit:c,saveDraft:async(t,a)=>{try{const{error:n}=await e.from("configs").upsert({id:`draft_${t}`,config_data:a,updated_at:(new Date).toISOString()},{onConflict:"id"});return!n}catch(n){return!1}},saveGlobalSettings:r,saveLandingConfig:s,signOut:async()=>{await e.auth.signOut()},submitLead:t,submitRehabDiagnosis:l},Symbol.toStringTag,{value:"Module"})),u="https://script.google.com/macros/s/AKfycbzzlSQqgxbVjo1zlBG11OyQmAUJUX6rF4-EDslma5lzc_56kIeHycbIFJjcuFKvZ0v4/exec",m=()=>u.startsWith("https://script.google.com"),y=[{Timestamp:"2024-03-20 10:00:00","Landing ID":"1",Name:"홍길동 (예시)",Phone:"010-1234-5678"},{Timestamp:"2024-03-19 15:30:00","Landing ID":"2",Name:"김철수 (예시)",Phone:"010-9876-5432"}],g=async e=>{try{return await t(e)}catch(a){return f(e)}},f=async e=>{if(!m())return await new Promise(e=>setTimeout(e,1e3)),!0;try{const t=new FormData;return t.append("type","lead"),t.append("api_token","landing-factory-secure-2026-jhBx9pQm7sK2vN4L"),t.append("origin",window.location.host),Object.keys(e).forEach(a=>{void 0!==e[a]&&t.append(a,String(e[a]))}),await fetch(u,{method:"POST",body:t,mode:"no-cors"}),!0}catch(t){return!1}},h=async e=>{if(!m())return alert("Mock Mode: Leads deleted successfully."),{result:"success",deleted:e.length};try{const t=new FormData;t.append("type","lead_delete"),t.append("leads",JSON.stringify(e));await fetch(u,{method:"POST",body:t,mode:"cors"});const a=new URLSearchParams;a.append("type","lead_delete"),a.append("leads",JSON.stringify(e));const n=await fetch(u,{method:"POST",body:a,headers:{"Content-Type":"application/x-www-form-urlencoded"}});if(!n.ok)throw new Error("HTTP "+n.status);return await n.json()}catch(t){return{result:"error",message:String(t)}}},_=async e=>{try{await c(e)}catch(t){}if(m())try{const t=new FormData;t.append("type","visit"),Object.keys(e).forEach(a=>{t.append(a,String(e[a]))}),fetch(u,{method:"POST",body:t,mode:"no-cors"}).catch(()=>{})}catch(a){}},w=async()=>{try{const e=await a();if(e&&e.length>0)return e}catch(e){}return m()?b("leads"):y},S=async()=>{try{const e=await d();if(e&&e.length>0)return e}catch(e){}return m()?b("visits"):[]},b=async(e,t)=>{try{let a=`${u}?type=${e}`;t&&(a+=`&id=${t}`);const n=fetch(a),r=new Promise((e,t)=>setTimeout(()=>t(new Error("Request timed out")),1e4)),o=await Promise.race([n,r]);if(!o.ok)throw new Error(`HTTP Error: ${o.status}`);return await o.json()}catch(a){return"config"===e?null:[]}},v=async e=>{let t=!1;try{t=await s(e)}catch(a){}if(m())try{const t=JSON.stringify(e),a=new FormData;a.append("type","config_save"),a.append("id",e.id),a.append("config_data",t),fetch(u,{method:"POST",body:a,mode:"no-cors"}).catch(()=>{})}catch(n){}return localStorage.removeItem(`landing_config_${e.id}`),t||m()},T=e=>{try{const t=localStorage.getItem(e);if(!t)return null;const a=JSON.parse(t);return(new Date).getTime()>a.expiry?(localStorage.removeItem(e),null):a.data}catch(t){return null}},O=(e,t)=>{try{const a={data:t,expiry:(new Date).getTime()+18e5};localStorage.setItem(e,JSON.stringify(a))}catch(a){}},D=async e=>{const t=T(`landing_config_${e}`);if(t)return t;try{const t=await o(e);if(t)return O(`landing_config_${e}`,t),t}catch(n){}if(!m())return null;const a=await b("config",e);return a&&O(`landing_config_${e}`,a),a},P=async()=>{if(!m())return[];const e=await b("configs");return Array.isArray(e)?e:[]},I=async(e,t="landing-factory image")=>m()?new Promise(a=>{const n=new FileReader;n.readAsDataURL(e),n.onload=n=>{var r;const o=null==(r=n.target)?void 0:r.result,s=(e,n,r)=>{const o=new URLSearchParams;o.append("type","upload_image"),o.append("filename",r),o.append("mimeType",n),o.append("base64",e),o.append("folderName",t),fetch(u,{method:"POST",body:o,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(async e=>{if(!e.ok)throw new Error("HTTP "+e.status);const t=await e.text();try{const e=JSON.parse(t);e.url?a(e.url):(alert("업로드 실패: "+e.message),a(null))}catch(n){alert("서버 응답 오류: "+t),a(null)}}).catch(e=>{alert("업로드 전송 오류: "+e),a(null)})};if(e.type.match(/image\/(jpeg|png|webp)/)){const t=new Image;t.src=o,t.onload=()=>{const a=document.createElement("canvas"),n=1280;let r=t.width,o=t.height;r>n&&(o=Math.round(o*(n/r)),r=n),a.width=r,a.height=o;const i=a.getContext("2d");null==i||i.drawImage(t,0,0,r,o);const c=a.toDataURL("image/jpeg",.7).split(",")[1],d=e.name.replace(/\.[^/.]+$/,"")+".jpg";s(c,"image/jpeg",d)},t.onerror=()=>{const t=o.split(",")[1];s(t,e.type,e.name)}}else{const t=o.split(",")[1];s(t,e.type,e.name)}},n.onerror=()=>{alert("파일 읽기 실패"),a(null)}}):URL.createObjectURL(e),$=async e=>{let t=!1;try{t=await i(e)}catch(a){}if(m())try{const t=new URLSearchParams;t.append("type","config_delete"),t.append("id",e),fetch(u,{method:"POST",body:t,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).catch(()=>{})}catch(n){}try{const t=localStorage.getItem("landing_drafts");if(t){const a=JSON.parse(t);a[e]&&(delete a[e],localStorage.setItem("landing_drafts",JSON.stringify(a)))}}catch(a){}return localStorage.removeItem(`landing_config_${e}`),t||m()},j=async()=>m()?b("admin_sessions"):[],L=async e=>{if(!m())return!0;try{const t=`${u}?type=revoke_session&target_session_id=${e}`,a=await fetch(t);return"success"===(await a.json()).result}catch(t){return!1}},R=async()=>{if(!m())return[];try{const e=`${u}?type=admin_users_list`,t=await fetch(e);return await t.json()}catch(e){return[]}},k=async(e,t="",a="")=>{if(!m())return{result:"error"};try{const n=new FormData;return n.append("type","admin_user_add"),n.append("email",e),n.append("name",t),n.append("memo",a),await fetch(u,{method:"POST",body:n,mode:"no-cors"}),{result:"success"}}catch(n){return{result:"error",message:n.toString()}}},C=async e=>{if(!m())return!0;try{const t=new FormData;return t.append("type","admin_user_remove"),t.append("email",e),await fetch(u,{method:"POST",body:t,mode:"no-cors"}),!0}catch(t){return!1}},F=async()=>{const e=T("system_global_v1");if(e)return e;try{const e=await n();if(e)return O("system_global_v1",e),e}catch(r){}if(!m())return null;const t=await fetch(`${u}?type=config&id=system_global_v1`),a=await t.json();return a.error?null:(O("system_global_v1",a),a)},N=async e=>{O("system_global_v1",e);try{await r(e)}catch(a){}if(!m())return!0;const t=new FormData;t.append("type","config_save"),t.append("id","system_global_v1"),t.append("config_data",JSON.stringify(e));try{return fetch(u,{method:"POST",body:t,mode:"no-cors"}),!0}catch(a){return!1}},A=async()=>{if(!m())return[];try{const e=await fetch(`${u}?type=sync_fonts`),t=await e.json();return Array.isArray(t)?t:[]}catch(e){return[]}},U=Object.freeze(Object.defineProperty({__proto__:null,addAdminUser:k,adminLogin:async(e,t,a)=>{if(!m())return"mock-session-id";try{const n=new FormData;n.append("type","admin_login"),n.append("ip",e),n.append("device",t),n.append("user_agent",a);await fetch(u,{method:"POST",body:n,mode:"no-cors"});const r=`${u}?type=admin_login&ip=${encodeURIComponent(e)}&device=${encodeURIComponent(t)}&user_agent=${encodeURIComponent(a)}`,o=await fetch(r),s=await o.json();return"success"===s.result?s.session_id:null}catch(n){return null}},deleteLandingConfig:$,deleteLeads:h,fetchAdminSessions:j,fetchAdminUsers:R,fetchGlobalSettings:F,fetchLandingConfigById:D,fetchLandingConfigs:P,fetchLeads:w,fetchProxyFont:async e=>{if(!m())return null;try{const t=await fetch(`${u}?type=proxy_font&id=${e}`),a=await t.json();if("success"===a.result&&a.data){const e=a.mime||"font/in-process";return{data:`data:${e};base64,${a.data}`,format:a.format||"truetype"}}return null}catch(t){return null}},fetchVisits:S,logVisit:_,manageVirtualData:async(e,t)=>{if(!m())return alert("Mock: Virtual Data Action "+t),"sync_data"===t?{result:"success",data:[]}:{result:"success",url:"#"};try{const a=new FormData;a.append("type","virtual_data"),a.append("landing_id",e),a.append("action",t);const n=new URLSearchParams;n.append("type","virtual_data"),n.append("landing_id",e),n.append("action",t);const r=await fetch(u,{method:"POST",body:n,headers:{"Content-Type":"application/x-www-form-urlencoded"}});return await r.json()}catch(a){return{result:"error",message:String(a)}}},removeAdminUser:C,revokeSession:L,saveGlobalSettings:N,saveLandingConfig:v,sendAdminNotification:async(e,t,a)=>{if(!m())return!0;try{const n=new FormData;return n.append("type","admin_email"),n.append("recipient",e),n.append("subject",t),n.append("body",a),await fetch(u,{method:"POST",body:n,mode:"no-cors"}),!0}catch(n){return!1}},submitLead:g,submitLeadToSheet:f,submitRehabDiagnosis:async e=>{let t=!1;try{t=await l(e)}catch(a){}if(m())try{const t=new FormData;t.append("type","rehab_diagnosis"),t.append("Timestamp",e.timestamp||(new Date).toLocaleString("ko-KR")),t.append("고객명",e.name),t.append("연락처",e.phone),t.append("거주지",e.address),t.append("소득",String(e.monthlyIncome)),t.append("부양가족",String(e.familySize)),t.append("총채무",String(e.totalDebt)),t.append("재산",String(e.assets)),t.append("배우자재산",String(e.spouseAssets||0)),t.append("예상월변제금",String(e.monthlyPayment)),t.append("탕감률",String(e.debtReductionRate)),t.append("관할법원",e.courtName),t.append("상태",e.status),fetch(u,{method:"POST",body:t,mode:"no-cors"}).catch(()=>{})}catch(n){}return t||m()},syncFontsFromDrive:A,uploadImageToDrive:I,verifyGoogleToken:async e=>{if(!m())return{valid:!0,email:"mock@example.com",sessionId:"mock-session"};try{const t=`${u}?type=google_login&token=${encodeURIComponent(e)}`,a=await fetch(t);return await a.json()}catch(t){return{valid:!1,message:"Network Error"}}},verifySession:async e=>{if(!m())return!0;try{const t=`${u}?type=verify_session&session_id=${e}`,a=await fetch(t);return!0===(await a.json()).valid}catch(t){return!0}}},Symbol.toStringTag,{value:"Module"}));export{w as a,N as b,F as c,v as d,D as e,P as f,f as g,g as h,$ as i,h as j,S as k,_ as l,R as m,j as n,k as o,L as p,p as q,C as r,A as s,U as t,I as u};
